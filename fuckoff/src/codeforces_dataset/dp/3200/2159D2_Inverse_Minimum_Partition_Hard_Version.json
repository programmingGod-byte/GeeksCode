{
    "contestId": 2159,
    "index": "D2",
    "title": "D2. Inverse Minimum Partition (Hard Version)",
    "statement": "This is the hard version of the problem. The difference between the versions is that in this version, you are asked to find the sum of $$$f(b)$$$ over all contiguous subsequences $$$b$$$ of $$$a$$$. You can hack only if you solved all versions of this problem.\nFor some sequence $$$b$$$ of $$$k$$$ positive integers, the cost of the sequence is defined as follows$$$^{\\text{∗}}$$$:\n$$$$$$\\mathtt{cost}(b)=\\left\\lceil{\\frac{b_k}{\\min(b_1,b_2,\\ldots,b_k)}}\\right\\rceil$$$$$$\nAssume that you partition a sequence $$$c$$$ into one or more sequences, so that the sequences become $$$c$$$ when concatenated. For example, when the sequence $$$c$$$ is $$$[3,1,4,1,5]$$$, a few valid ways to partition the sequence are $$$[[3,1],[4,1,5]]$$$, $$$[[3],[1,4,1],[5]]$$$, $$$[[3,1,4,1,5]]$$$. On the other hand, $$$[[3,1],[1,5]]$$$ and $$$[[3,4,1],[1,5]]$$$ are not valid ways to partition the sequence.\nFor a partition of a sequence $$$c$$$ of positive integers, the total cost of the partition is defined as the sum of the costs of each sequence in the partition. Then, let us define $$$f(c)$$$ as the minimum total cost to partition the sequence $$$c$$$.\nGiven a sequence $$$a$$$ of $$$n$$$ positive integers, you must compute the following:\n$$$$$$\\sum_{l=1}^{n} {\\sum_{r=l}^{n} f([a_l,a_{l+1},\\ldots,a_r])}$$$$$$\n$$$^{\\text{∗}}$$$Given a real value $$$x$$$, $$$\\left\\lceil{x}\\right\\rceil$$$ is defined as the smallest integer no less than $$$x$$$. For example, the value of $$$\\left\\lceil{3.14}\\right\\rceil$$$ is $$$4$$$.",
    "inputSpecification": "Input\nEach test contains multiple test cases. The first line contains the number of test cases $$$t$$$ ($$$1 \\le t \\le 10^4$$$). The description of the test cases follows.\nThe first line of each test case contains a single integer $$$n$$$ ($$$1 \\le n \\le 4 \\cdot 10^5$$$).\nThe second line of each test case contains $$$a_1,a_2,\\ldots,a_n$$$ ($$$1 \\le a_i \\le 10^{18}$$$).\nIt is guaranteed that the sum of $$$n$$$ over all test cases does not exceed $$$4 \\cdot 10^5$$$.",
    "outputSpecification": "Output\nFor each test case, output the answer to the problem on a separate line.",
    "note": "Note\nFor the first test case, the following are all contiguous subsequences of $$$a$$$ and their corresponding values:\n$$$[3] \\to [[3]]$$$: $$$f([3])=1$$$;\n$$$[3,1] \\to [[3,1]]$$$: $$$f([3,1])=1$$$;\n$$$[3,1,4] \\to [[3,1],[4]]$$$: $$$f([3,1,4])=2$$$;\n$$$[3,1,4,1] \\to [[3,1,4,1]]$$$: $$$f([3,1,4,1])=1$$$;\n$$$[3,1,4,1,5] \\to [[3,1,4,1],[5]]$$$: $$$f([3,1,4,1,5])=2$$$;\n$$$[1] \\to [[1]]$$$: $$$f([1])=1$$$;\n$$$[1,4] \\to [[1],[4]]$$$: $$$f([1,4])=2$$$;\n$$$[1,4,1] \\to [[1,4,1]]$$$: $$$f([1,4,1])=1$$$;\n$$$[1,4,1,5] \\to [[1,4,1],[5]]$$$: $$$f([1,4,1,5])=2$$$;\n$$$[4] \\to [[4]]$$$: $$$f([4])=1$$$;\n$$$[4,1] \\to [[4,1]]$$$: $$$f([4,1])=1$$$;\n$$$[4,1,5] \\to [[4,1],[5]]$$$: $$$f([4,1,5])=2$$$;\n$$$[1] \\to [[1]]$$$: $$$f([1])=1$$$;\n$$$[1,5] \\to [[1],[5]]$$$: $$$f([1,5])=2$$$;\n$$$[5] \\to [[5]]$$$: $$$f([5])=1$$$.\nTherefore, the answer for the first test case is $$$1+1+2+1+2+1+2+1+2+1+1+2+1+2+1=21$$$.",
    "tags": [
        "dp",
        "greedy",
        "math"
    ],
    "rating": 3200
}